"""
–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç off-topic –∑–∞–ø—Ä–æ—Å–æ–≤.
"""
import re
import numpy as np
import logging

from typing import Tuple, Dict
from sentence_transformers import SentenceTransformer

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –£–†–û–í–ï–ù–¨ 1: –ß—ë—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —è–≤–Ω–æ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Ç–µ–º
BLACKLIST_CATEGORIES = {
    "–ø–æ–≥–æ–¥–∞": ["–ø–æ–≥–æ–¥–∞", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "–¥–æ–∂–¥—å", "—Å–Ω–µ–≥", "—Å–æ–ª–Ω–µ—á–Ω–æ", "–æ–±–ª–∞—á–Ω–æ"],
    "–∫—É–ª–∏–Ω–∞—Ä–∏—è": ["—Ä–µ—Ü–µ–ø—Ç", "–≥–æ—Ç–æ–≤–∏—Ç—å", "–ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å", "–∫—É–ª–∏–Ω–∞—Ä", "–≤–∞—Ä–∏—Ç—å", "–∂–∞—Ä–∏—Ç—å"],
    "–∫–∏–Ω–æ": ["—Ñ–∏–ª—å–º", "–∫–∏–Ω–æ", "—Å–µ—Ä–∏–∞–ª", "–∞–∫—Ç–µ—Ä", "–∞–∫—Ç—Ä–∏—Å–∞", "—Ä–µ–∂–∏—Å—Å–µ—Ä"],
    "—Å–ø–æ—Ä—Ç": ["—Ñ—É—Ç–±–æ–ª", "—Ö–æ–∫–∫–µ–π", "–±–∞—Å–∫–µ—Ç–±–æ–ª", "—Å–ø–æ—Ä—Ç", "–º–∞—Ç—á", "—á–µ–º–ø–∏–æ–Ω–∞—Ç"],
    "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": ["iphone", "android", "—Å–º–∞—Ä—Ç—Ñ–æ–Ω", "—Ç–µ–ª–µ—Ñ–æ–Ω", "–∫–æ–º–ø—å—é—Ç–µ—Ä", "–Ω–æ—É—Ç–±—É–∫"],
    "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç_–ª–∏—á–Ω—ã–π": ["–∞–≤—Ç–æ–º–æ–±–∏–ª—å", "–º–∞—à–∏–Ω–∞", "–∞–≤—Ç–æ", "bmw", "mercedes", "toyota"],
    "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": ["–∏–≥—Ä–∞", "–∏–≥—Ä–∞—Ç—å", "–≥–µ–π–º–µ—Ä", "–∫–æ–Ω—Å–æ–ª—å", "playstation", "xbox"],
    "–∑–¥–æ—Ä–æ–≤—å–µ": ["–±–æ–ª–µ–∑–Ω—å", "–ª–µ–∫–∞—Ä—Å—Ç–≤–æ", "–≤—Ä–∞—á", "–±–æ–ª—å–Ω–∏—Ü–∞", "–ª–µ—á–∏—Ç—å"],
    "–ø–æ–ª–∏—Ç–∏–∫–∞": ["–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç", "–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ", "–º–∏–Ω–∏—Å—Ç—Ä", "–≤—ã–±–æ—Ä—ã", "–ø–∞—Ä–ª–∞–º–µ–Ω—Ç"],
}

# –¢–æ–∫—Å–∏—á–Ω—ã–µ/–∞—Ç–∞–∫—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
TOXIC_PATTERNS = [
    r"–∏–≥–Ω–æ—Ä[–∏—É]–π",
    r"–∑–∞–±—É–¥—å",
    r"—Ç—ã (—Ç—É–ø–æ–π|–≥–ª—É–ø—ã–π|–∏–¥–∏–æ—Ç)",
    r"–∫–∞–∫ (–≤–∑–ª–æ–º–∞—Ç—å|—Ö–∞–∫–Ω—É—Ç—å)",
    r"secret[_\s]?key",
    r"–ø–∞—Ä–æ–ª—å",
]

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –£–†–û–í–ï–ù–¨ 2: –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

WHITELIST_KEYWORDS = {
    "–∫–æ–º–ø–∞–Ω–∏—è": ["—Ç—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å", "transneft", "–ø–∞–æ", "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ", "–∫–æ–º–ø–∞–Ω–∏—è"],
    "–¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å": ["–Ω–µ—Ñ—Ç–µ–ø—Ä–æ–≤–æ–¥", "–Ω–µ—Ñ—Ç—å", "—Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥", "–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å", 
                     "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞", "–ø–µ—Ä–µ–∫–∞—á–∫–∞", "—ç–∫—Å–ø–æ—Ä—Ç", "–∏–º–ø–æ—Ä—Ç"],
    "–≥–µ–æ–≥—Ä–∞—Ñ–∏—è": ["—Ä–æ—Å—Å–∏—è", "–º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ", "—Ä–µ–≥–∏–æ–Ω", "–æ–±–ª–∞—Å—Ç—å", "–∫—Ä–∞–π"],
    "–±–∏–∑–Ω–µ—Å": ["–≤—ã—Ä—É—á–∫–∞", "–ø—Ä–∏–±—ã–ª—å", "–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–ø—Ä–æ–µ–∫—Ç", "–∫–æ–Ω—Ç—Ä–∞–∫—Ç"],
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –£–†–û–í–ï–ù–¨ 3: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –æ –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏ (–¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
REFERENCE_QUERIES = [
    "–ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –ü–ê–û –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å?",
    "–ö–∞–∫–∞—è –¥–ª–∏–Ω–∞ –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–≤–æ–¥–æ–≤ –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏?",
    "–ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –æ–±—ä–µ–∫—Ç—ã –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏?",
    "–ö–∞–∫–∞—è –≤—ã—Ä—É—á–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å?",
    "–ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏",
    "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏",
    "–°–∫–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–º–ø–∞–Ω–∏–∏?",
    "–ö–∞–∫–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —Ä–µ–∞–ª–∏–∑—É–µ—Ç –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å?",
    "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥",
    "–ö—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∞–∫—Ü–∏–æ–Ω–µ—Ä–∞–º–∏ –ü–ê–û –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å?",
    "–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏",
    "–ö–∞–∫–∞—è –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã—Ö –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–≤–æ–¥–æ–≤?",
]

_semantic_model = None

def get_semantic_model():
    """–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."""
    global _semantic_model
    if _semantic_model is None:
        print("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞...")
        _semantic_model = SentenceTransformer('intfloat/multilingual-e5-small')
        print("‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
    return _semantic_model


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ü–†–û–í–ï–†–ö–ò
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def check_blacklist(question: str) -> Tuple[bool, str]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫."""
    question_lower = question.lower()

    # 1. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    for category, keywords in BLACKLIST_CATEGORIES.items():
        for keyword in keywords:
            if keyword in question_lower:
                return False, f"blacklist_{category}"

    # 2. –¢–æ–∫—Å–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    for pattern in TOXIC_PATTERNS:
        if re.search(pattern, question_lower):
            return False, "toxic_pattern"

    return True, ""


def check_whitelist(question: str) -> Tuple[bool, float]:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫.
    Returns: (passed, score) –≥–¥–µ score = % —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π —Å –±–µ–ª—ã–º —Å–ø–∏—Å–∫–æ–º
    """
    question_lower = question.lower()

    total_keywords = sum(len(kws) for kws in WHITELIST_KEYWORDS.values())
    matched_keywords = 0

    for category, keywords in WHITELIST_KEYWORDS.items():
        for keyword in keywords:
            if keyword in question_lower:
                matched_keywords += 1

    score = matched_keywords / total_keywords if total_keywords > 0 else 0

    # –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –¥–ª–∏–Ω–Ω—ã–π (>5 —Å–ª–æ–≤) –∏ –Ω–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ - –±–ª–æ–∫–∏—Ä—É–µ–º
    words = question_lower.split()
    if len(words) >= 5 and score == 0:
        return False, score

    return True, score


def check_semantic_similarity(question: str, threshold: float = 0.4) -> Tuple[bool, float]:
    """
    –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç–∏.

    Args:
        question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        threshold: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ similarity (0.4 = 40%)

    Returns:
        (passed, max_similarity)
    """
    try:
        model = get_semantic_model()

        # –≠–º–±–µ–¥–¥–∏–Ω–≥–∏
        question_emb = model.encode([question])[0]
        reference_embs = model.encode(REFERENCE_QUERIES)

        # –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
        similarities = [
            np.dot(question_emb, ref_emb) / (np.linalg.norm(question_emb) * np.linalg.norm(ref_emb))
            for ref_emb in reference_embs
        ]

        max_similarity = max(similarities)

        passed = max_similarity >= threshold
        return passed, max_similarity

    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: {e}")
        return True, 0.0  # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def is_question_relevant_advanced(question: str, use_semantic: bool = True) -> Tuple[bool, Dict]:

    logger = logging.getLogger(__name__)

    logger.debug(f"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–ø—Ä–æ—Å–∞: {question}")

    question_lower = question.lower()

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –£–†–û–í–ï–ù–¨ 1: IRRELEVANT (—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –º–Ω–µ–Ω–∏—è)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    irrelevant_patterns = [
        r'\b(–µ–≤—Ä–æ–ø–∞|–∞–º–µ—Ä–∏–∫–∞|–∞–∑–∏—è)\s+(–ª—É—á—à–µ|—Ö—É–∂–µ)',  # "–ï–≤—Ä–æ–ø–∞ –ª—É—á—à–µ?"
        r'\b(–ª—É—á—à–µ|—Ö—É–∂–µ)\s+—á–µ–º\b',  # "–õ—É—á—à–µ —á–µ–º..."
        r'\b–∫–∞–∫ –¥–µ–ª–∞\b',  # "–ö–∞–∫ –¥–µ–ª–∞?"
        r'\b(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π)\b',  # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        r'\b—á—Ç–æ –Ω–æ–≤–æ–≥–æ\b',  # "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"
    ]

    for pattern in irrelevant_patterns:
        if re.search(pattern, question_lower):
            return False, {
                "reason": "irrelevant_topic",
                "pattern": pattern,
                "severity": "high"
            }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –£–†–û–í–ï–ù–¨ 2: TOXIC PATTERNS (–∞—Ç–∞–∫–∏, prompt injection)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    for pattern in TOXIC_PATTERNS:
        if re.search(pattern, question_lower):
            return False, {
                "reason": "toxic_pattern",
                "pattern": pattern,
                "severity": "critical"
            }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –£–†–û–í–ï–ù–¨ 3: BLACKLIST (–ø–æ–≥–æ–¥–∞, –∫–∏–Ω–æ, —Å–ø–æ—Ä—Ç)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    for category, keywords in BLACKLIST_CATEGORIES.items():
        for keyword in keywords:
            if keyword in question_lower:
                return False, {
                    "reason": f"blacklist_{category}",
                    "severity": "high"
                }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –£–†–û–í–ï–ù–¨ 4: WHITELIST (–±–∏–∑–Ω–µ—Å-–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    business_keywords = [
        '–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω', '—É–ø—Ä–∞–≤–ª–µ–Ω–∏', '—Å—Ç—Ä—É–∫—Ç—É—Ä', '—Å–æ–≤–µ—Ç', '–¥–∏—Ä–µ–∫—Ç–æ—Ä',
        '–∞–∫—Ü–∏–æ–Ω–µ—Ä', '–≤—ã—Ä—É—á–∫', '–ø—Ä–∏–±—ã–ª', '–¥–æ—Ö–æ–¥', '—Ñ–∏–Ω–∞–Ω—Å', '–æ—Ç—á—ë—Ç',
        '–¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç', '–±–∏–∑–Ω–µ—Å', '–∫–æ–º–ø–∞–Ω–∏', '–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏', '—Ç—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç',
        '–Ω–µ—Ñ—Ç–µ–ø—Ä–æ–≤–æ–¥', '–Ω–µ—Ñ—Ç', '–ø–µ—Ä—Å–æ–Ω–∞–ª', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏',
        '—Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥', '–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å', '–ø–µ—Ä–µ–∫–∞—á–∫', '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'
    ]

    if any(kw in question_lower for kw in business_keywords):
        return True, {
            "reason": "business_keywords",
            "severity": "low",
            "passed_all": True
        }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –£–†–û–í–ï–ù–¨ 5: QUESTION WORDS (–≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    question_words = ['—á—Ç–æ', '–∫–∞–∫', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–ø–æ—á–µ–º—É', '—Å–∫–æ–ª—å–∫–æ',
                      '–∫–∞–∫–æ–π', '–∫–∞–∫–∞—è', '–∫–∞–∫–∏–µ', '–∫—Ç–æ', '—á–µ–º', '–∑–∞—á–µ–º']

    if any(question_lower.startswith(qw) for qw in question_words):
        # –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ, –Ω–æ –Ω–µ—Ç –±–∏–∑–Ω–µ—Å-—Ç–µ—Ä–º–∏–Ω–æ–≤
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–º–∞–Ω—Ç–∏–∫—É
        if use_semantic:
            passed_semantic, semantic_score = check_semantic_similarity(question, threshold=0.4)

            if passed_semantic:
                return True, {
                    "reason": "semantic_match",
                    "severity": "low",
                    "semantic_score": semantic_score
                }
            else:
                return False, {
                    "reason": "low_semantic_similarity",
                    "severity": "medium",
                    "semantic_score": semantic_score
                }
        else:
            # –°–µ–º–∞–Ω—Ç–∏–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            return True, {
                "reason": "valid_question_format",
                "severity": "low"
            }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –£–†–û–í–ï–ù–¨ 6: FINAL REJECTION (–Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    return False, {
        "reason": "no_keywords",
        "level": "whitelist",
        "severity": "medium",
        "whitelist_score": 0.0
    }


def get_rejection_message_advanced(details: Dict) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è."""

    severity = details.get("severity", "medium")
    reason = details.get("reason", "unknown")

    if severity == "high" or "toxic" in reason:
        return (
            "–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, —è –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å. "
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –ü–ê–û ¬´–¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å¬ª."
        )

    if "blacklist" in reason:
        return (
            "–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, —è –Ω–µ –∑–Ω–∞—é –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. "
            "–í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –Ω–µ —Å–≤—è–∑–∞–Ω —Å –ü–ê–û ¬´–¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å¬ª. "
            "–Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ –Ω–µ—Ñ—Ç–µ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏."
        )

    if "semantic" in reason:
        score = details.get("semantic_score", 0)
        return (
            f"–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, –≤–∞—à –≤–æ–ø—Ä–æ—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤—è–∑–∞–Ω —Å –ü–ê–û ¬´–¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å¬ª "
            f"(—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {score*100:.0f}%). "
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ."
        )

    return (
        "–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, —è –Ω–µ –Ω–∞—à—ë–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É. "
        "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –ü–ê–û ¬´–¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å¬ª –µ—â—ë —Ä–∞–∑."
    )